generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CVStatus {
  PENDING
  EXTRACTED
  EDITING
  IMPROVED
  GENERATED
  COMPLETED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum StepStatus {
  PENDING
  WAITING_INPUTS
  RUNNING
  COMPLETED
  FAILED
  SKIPPED
}

enum AudioStatus {
  PENDING
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

model CV {
  id              String    @id @default(cuid())

  // Source file info
  originalName    String
  originalKey     String    // B2 key for original file
  originalUrl     String?   // Public URL if available

  // Consultant info (extracted)
  consultantName  String?
  title           String?

  // Extracted/edited content
  markdownContent String?   @db.Text

  // Missing info tracking
  missingFields   String[]  @default([])

  // User notes
  notes              String?   @db.Text  // Notes contexte missions passées
  futureMissionNotes String?   @db.Text  // Notes contexte mission à venir

  // Status tracking
  status          CVStatus  @default(PENDING)
  templateName    String    @default("DREAMIT")

  // Generated file
  generatedKey    String?   // B2 key for generated DOCX
  generatedUrl    String?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  extractedAt     DateTime?
  generatedAt     DateTime?

  // Improvements history
  improvements    Improvement[]

  // Workflow executions
  workflowExecutions WorkflowExecution[]

  // Audio notes
  audioNotes      AudioNote[]

  // Logs d'exécution des agents
  agentExecutionLogs AgentExecutionLog[]
}

model Improvement {
  id          String   @id @default(cuid())
  cv          CV       @relation(fields: [cvId], references: [id], onDelete: Cascade)
  cvId        String

  agentType   String   // enrichisseur, adaptateur, contexte, bio
  prompt      String   @db.Text
  result      String   @db.Text
  appliedAt   DateTime @default(now())
}

model Template {
  id          String   @id @default(cuid())
  name        String   @unique  // DREAMIT, RUPTURAE, etc.
  displayName String

  // Couleurs
  primaryColor   String  @default("#1E3A8A")
  secondaryColor String  @default("#3B82F6")
  textColor      String  @default("#1F2937")
  mutedColor     String  @default("#6B7280")

  // Logos (URLs Backblaze B2)
  logoUrl        String?  // @deprecated - utilisez logoHeaderUrl/logoFooterUrl
  logoHeaderUrl  String?  // Logo en haut à gauche de la première page
  logoFooterUrl  String?  // Logo en pied de page

  // Site web du template
  website        String?

  // Structure du template (JSON validé par Zod côté application)
  // Contient: logos config, margins, fonts, spacing, pagination, styles, sections
  config      String   @db.Text

  // Métadonnées
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AIAgent {
  id                 String   @id @default(cuid())
  name               String   @unique  // enrichisseur, adaptateur, contexte, bio, extraction
  displayName        String
  description        String   @db.Text

  // Prompts
  systemPrompt       String   @db.Text
  userPromptTemplate String   @db.Text  // Template avec placeholders {{markdown}}, {{context}}

  // Métadonnées
  isActive           Boolean  @default(true)
  order              Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Position visuelle dans le workflow editor
  positionX          Float?
  positionY          Float?

  // Connexions pour workflow
  sourceConnections  AgentConnection[] @relation("SourceAgent")
  targetConnections  AgentConnection[] @relation("TargetAgent")
  workflowSteps      WorkflowStep[]

  // Logs d'exécution pour analyse des prompts
  executionLogs      AgentExecutionLog[]
}

model AgentConnection {
  id            String   @id @default(cuid())

  // Agent source (celui qui envoie des données)
  sourceAgentId String
  sourceAgent   AIAgent  @relation("SourceAgent", fields: [sourceAgentId], references: [id], onDelete: Cascade)

  // Agent cible (celui qui reçoit les données)
  targetAgentId String
  targetAgent   AIAgent  @relation("TargetAgent", fields: [targetAgentId], references: [id], onDelete: Cascade)

  // Ordre d'exécution et état
  order         Int      @default(0)
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([sourceAgentId, targetAgentId])
  @@index([sourceAgentId])
  @@index([targetAgentId])
}

model WorkflowExecution {
  id          String          @id @default(cuid())

  // CV concerné
  cvId        String
  cv          CV              @relation(fields: [cvId], references: [id], onDelete: Cascade)

  // Statut global
  status      ExecutionStatus @default(PENDING)

  // Données d'entrée initiales
  inputData   String?         @db.Text  // JSON avec contexte additionnel

  // Résultat final
  outputData  String?         @db.Text  // JSON avec résultat agrégé
  error       String?         @db.Text

  // Timestamps
  startedAt   DateTime        @default(now())
  completedAt DateTime?

  // Étapes d'exécution
  steps       WorkflowStep[]
}

model WorkflowStep {
  id           String      @id @default(cuid())

  // Référence à l'exécution
  executionId  String
  execution    WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  // Agent concerné
  agentId      String
  agent        AIAgent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Statut de l'étape
  status       StepStatus  @default(PENDING)

  // Position dans le graphe de workflow
  isLeafAgent  Boolean     @default(false)  // true si cet agent est terminal (pas de successeurs)

  // Données d'entrée (reçues des agents sources)
  inputData    String?     @db.Text  // JSON

  // Résultat de l'agent
  outputData   String?     @db.Text  // JSON
  error        String?     @db.Text

  // Timestamps
  startedAt    DateTime?
  completedAt  DateTime?

  // BullMQ job tracking
  jobId        String?     @unique

  @@index([executionId])
  @@index([agentId])
  @@index([jobId])
}

model AudioNote {
  id              String      @id @default(cuid())
  cvId            String
  cv              CV          @relation(fields: [cvId], references: [id], onDelete: Cascade)

  // Fichier audio
  originalName    String      // Nom du fichier uploadé
  audioKey        String      // Clé B2 (audio/{consultantName}/{timestamp}.ext)
  audioUrl        String?     // URL publique B2
  duration        Int?        // Durée en secondes
  mimeType        String      // audio/ogg, audio/mp4, etc.
  fileSize        Int         // Taille en bytes

  // Transcription (pour plus tard avec Soniox)
  transcription   String?     @db.Text
  language        String?
  status          AudioStatus @default(PENDING)
  errorMessage    String?

  // Soniox tracking (pour plus tard)
  sonioxFileId    String?
  sonioxJobId     String?

  createdAt       DateTime    @default(now())
  transcribedAt   DateTime?

  @@index([cvId])
}

// Logs détaillés des exécutions d'agents pour analyse et amélioration des prompts
model AgentExecutionLog {
  id                  String    @id @default(cuid())

  // Relations
  agentId             String
  agent               AIAgent   @relation(fields: [agentId], references: [id], onDelete: Cascade)

  cvId                String
  cv                  CV        @relation(fields: [cvId], references: [id], onDelete: Cascade)

  // Contexte d'exécution (optionnel - null si exécution directe via API improve)
  executionId         String?
  stepId              String?

  // Inputs - Prompts envoyés au LLM
  systemPrompt        String    @db.Text
  userPrompt          String    @db.Text

  // Inputs - Données injectées dans le template
  inputMarkdown       String    @db.Text  // Markdown du CV en entrée
  pastMissionNotes    String?   @db.Text  // Notes missions passées (si présentes)
  futureMissionNotes  String?   @db.Text  // Notes mission future (si présentes)

  // Output - Réponse du LLM
  outputMarkdown      String?   @db.Text  // Résultat généré (null si erreur)

  // Métriques
  durationMs          Int?      // Durée de l'appel LLM en ms
  tokensInput         Int?      // Nombre de tokens en entrée (si disponible)
  tokensOutput        Int?      // Nombre de tokens en sortie (si disponible)

  // Statut
  success             Boolean   @default(true)
  error               String?   @db.Text

  // Timestamps
  createdAt           DateTime  @default(now())

  @@index([agentId])
  @@index([cvId])
  @@index([executionId])
  @@index([createdAt])
}
